<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Html5-game by novitskiy-aleksei</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <link rel="stylesheet" type="text/css" href="assets/demoStyles.css" />

    <script type="text/javascript" src="assets/preloadjs-NEXT.min.js"></script>
    <script type="text/javascript" src="assets/soundjs-NEXT.min.js"></script>

    <!-- Note: All core EaselJS classes are listed here: -->
    <script type="text/javascript" src="createjs/events/Event.js"></script>
    <script type="text/javascript" src="createjs/events/EventDispatcher.js"></script>
    <script type="text/javascript" src="createjs/utils/IndexOf.js"></script>
    <script type="text/javascript" src="easeljs/utils/UID.js"></script>
    <script type="text/javascript" src="easeljs/utils/Ticker.js"></script>
    <script type="text/javascript" src="easeljs/geom/Matrix2D.js"></script>
    <script type="text/javascript" src="easeljs/geom/Point.js"></script>
    <script type="text/javascript" src="easeljs/geom/Rectangle.js"></script>
    <script type="text/javascript" src="easeljs/display/Shadow.js"></script>
    <script type="text/javascript" src="easeljs/display/SpriteSheet.js"></script>
    <script type="text/javascript" src="easeljs/display/Graphics.js"></script>
    <script type="text/javascript" src="easeljs/display/DisplayObject.js"></script>
    <script type="text/javascript" src="easeljs/display/Container.js"></script>
    <script type="text/javascript" src="easeljs/display/Stage.js"></script>
    <script type="text/javascript" src="easeljs/display/Bitmap.js"></script>
    <script type="text/javascript" src="easeljs/display/Sprite.js"></script>
    <script type="text/javascript" src="easeljs/display/BitmapAnimation.js"></script>
    <script type="text/javascript" src="easeljs/display/BitmapText.js"></script>
    <script type="text/javascript" src="easeljs/display/Shape.js"></script>
    <script type="text/javascript" src="easeljs/display/Text.js"></script>
    <script type="text/javascript" src="easeljs/display/DOMElement.js"></script>
    <script type="text/javascript" src="easeljs/events/MouseEvent.js"></script>
    <script type="text/javascript" src="easeljs/filters/Filter.js"></script>
    <script type="text/javascript" src="easeljs/ui/ButtonHelper.js"></script>
    <script type="text/javascript" src="easeljs/ui/Touch.js"></script>
    <script type="text/javascript" src="easeljs/utils/SpriteSheetUtils.js"></script>
    <script type="text/javascript" src="easeljs/utils/SpriteSheetBuilder.js"></script>

    <!-- We also provide hosted minified versions of all CreateJS libraries.
        http://code.createjs.com -->

    <!-- Game script below -->
    <script type="text/javascript" src="assets/SpaceRock.js"></script>
    <script type="text/javascript" src="assets/Ship.js"></script>

    <script>

    var DIFFICULTY = 2;			//how fast the game gets mor difficult
    var ROCK_TIME = 110;		//aprox tick count until a new asteroid gets introduced
    var SUB_ROCK_COUNT = 4;		//how many small rocks to make on rock death
    var BULLET_TIME = 5;		//ticks between bullets
    var BULLET_ENTROPY = 100;	//how much energy a bullet has before it runs out.

    var TURN_FACTOR = 7;		//how far the ship turns per frame
    var BULLET_SPEED = 17;		//how fast the bullets move

    var KEYCODE_ENTER = 13;		//usefull keycode
    var KEYCODE_SPACE = 32;		//usefull keycode
    var KEYCODE_UP = 38;		//usefull keycode
    var KEYCODE_LEFT = 37;		//usefull keycode
    var KEYCODE_RIGHT = 39;		//usefull keycode
    var KEYCODE_W = 87;			//usefull keycode
    var KEYCODE_A = 65;			//usefull keycode
    var KEYCODE_D = 68;			//usefull keycode

    var shootHeld;			//is the user holding a shoot command
    var lfHeld;				//is the user holding a turn left command
    var rtHeld;				//is the user holding a turn right command
    var fwdHeld;			//is the user holding a forward command

    var timeToRock;			//difficulty adjusted version of ROCK_TIME
    var nextRock;			//ticks left until a new space rock arrives
    var nextBullet;			//ticks left until the next shot is fired

    var rockBelt;			//space rock array
    var bulletStream;		//bullet array

    var canvas;			//Main canvas
    var stage;			//Main display stage

    var ship;			//the actual ship
    var alive;			//wheter the player is alive

    var messageField;		//Message display field
    var scoreField;			//score Field

    var loadingInterval = 0;

    var preload;

    //register key functions
    document.onkeydown = handleKeyDown;
    document.onkeyup = handleKeyUp;

    var preload;

    function init() {
        if (window.top != window) {
            document.getElementById("header").style.display = "none";
        }

        if (!createjs.Sound.initializeDefaultPlugins()) {
            document.getElementById("error").style.display = "block";
            document.getElementById("content").style.display = "none";
            return;
        }

        if (createjs.Sound.BrowserDetect.isIOS || createjs.Sound.BrowserDetect.isAndroid) {  // || createjs.Sound.BrowserDetect.isBlackberry  OJR blackberry has not been tested yet
            document.getElementById("mobile").style.display = "block";
            document.getElementById("content").style.display = "none";
            return;
        }

        canvas = document.getElementById("gameCanvas");
        stage = new createjs.Stage(canvas);
        messageField = new createjs.Text("Loading", "bold 24px Arial", "#FFFFFF");
        messageField.maxWidth = 1000;
        messageField.textAlign = "center";
        messageField.x = canvas.width / 2;
        messageField.y = canvas.height / 2;
        stage.addChild(messageField);
        stage.update(); 	//update the stage to show text

        // begin loading content (only sounds to load)
        var manifest = [
            {id:"begin", src:"assets/Game-Spawn.mp3|assets/Game-Spawn.ogg"},
            {id:"break", src:"assets/Game-Break.mp3|assets/Game-Break.ogg", data:6},
            {id:"death", src:"assets/Game-Death.mp3|assets/Game-Death.ogg"},
            {id:"laser", src:"assets/Game-Shot.mp3|assets/Game-Shot.ogg", data:6},
            {id:"music", src:"assets/18-machinae_supremacy-lord_krutors_dominion.mp3|assets/18-machinae_supremacy-lord_krutors_dominion.ogg"}
        ];

        preload = new createjs.LoadQueue();
        preload.installPlugin(createjs.Sound);
        preload.addEventListener("complete", doneLoading); // add an event listener for when load is completed
        preload.addEventListener("progress", updateLoading);
        preload.loadManifest(manifest);
    }

    function stop() {
        if (preload != null) { preload.close(); }
        createjs.Sound.stop();
    }

    function updateLoading() {
        messageField.text = "Loading " + (preload.progress*100|0) + "%"
        stage.update();
    }


    function doneLoading(event) {
        clearInterval(loadingInterval);
        scoreField = new createjs.Text("0", "bold 12px Arial", "#FFFFFF");
        scoreField.textAlign = "right";
        scoreField.x = canvas.width - 10;
        scoreField.y = 22;
        scoreField.maxWidth = 1000;

        messageField.text = "Добро Пожаловать! \r\n Click to play";

        // start the music
        createjs.Sound.play("music", createjs.Sound.INTERRUPT_NONE, 0, 0, -1, 0.4);

        watchRestart();
    }

    function watchRestart() {
        //watch for clicks
        stage.addChild(messageField);
        stage.update(); 	//update the stage to show text
        canvas.onclick = handleClick;
    }

    function handleClick() {
        //prevent extra clicks and hide text
        canvas.onclick = null;
        stage.removeChild(messageField);

        // indicate the player is now on screen
        createjs.Sound.play("begin");

        restart();
    }

    //reset all game logic
    function restart() {
        //hide anything on stage and show the score
        stage.removeAllChildren();
        scoreField.text = (0).toString();
        stage.addChild(scoreField);

        //new arrays to dump old data
        rockBelt = new Array();
        bulletStream = new Array();

        //create the player
        alive = true;
        ship = new Ship();
        ship.x = canvas.width / 2;
        ship.y = canvas.height / 2;

        //log time untill values
        timeToRock = ROCK_TIME;
        nextRock = nextBullet = 0;

        //reset key presses
        shootHeld =	lfHeld = rtHeld = fwdHeld = dnHeld = false;

        //ensure stage is blank and add the ship
        stage.clear();
        stage.addChild(ship);

        //start game timer
        if (!createjs.Ticker.hasEventListener("tick")) {
            createjs.Ticker.addEventListener("tick", tick);
        }
    }

    function tick(event) {
        //handle firing
        if(nextBullet <= 0) {
            if(alive && shootHeld){
                nextBullet = BULLET_TIME;
                fireBullet();
            }
        } else {
            nextBullet--;
        }

        //handle turning
        if(alive && lfHeld){
            ship.rotation -= TURN_FACTOR;
        } else if(alive && rtHeld) {
            ship.rotation += TURN_FACTOR;
        }

        //handle thrust
        if(alive && fwdHeld){
            ship.accelerate();
        }

        //handle new spaceRocks
        if(nextRock <= 0) {
            if(alive){
                timeToRock -= DIFFICULTY;	//reduce spaceRock spacing slowly to increase difficulty with time
                var index = getSpaceRock(SpaceRock.LRG_ROCK);
                rockBelt[index].floatOnScreen(canvas.width, canvas.height);
                nextRock = timeToRock + timeToRock*Math.random();
            }
        } else {
            nextRock--;
        }

        //handle ship looping
        if(alive && outOfBounds(ship, ship.bounds)) {
            placeInBounds(ship, ship.bounds);
        }

        //handle bullet movement and looping
        for(bullet in bulletStream) {
            var o = bulletStream[bullet];
            if(!o || !o.active) { continue; }
            if(outOfBounds(o, ship.bounds)) {
                placeInBounds(o, ship.bounds);
            }
            o.x += Math.sin(o.rotation*(Math.PI/-180))*BULLET_SPEED;
            o.y += Math.cos(o.rotation*(Math.PI/-180))*BULLET_SPEED;

            if(--o.entropy <= 0) {
                stage.removeChild(o);
                o.active = false;
            }
        }

        //handle spaceRocks (nested in one loop to prevent excess loops)
        for(spaceRock in rockBelt) {
            var o = rockBelt[spaceRock];
            if(!o || !o.active) { continue; }

            //handle spaceRock movement and looping
            if(outOfBounds(o, o.bounds)) {
                placeInBounds(o, o.bounds);
            }
            o.tick(event);


            //handle spaceRock ship collisions
            if(alive && o.hitRadius(ship.x, ship.y, ship.hit)) {
                alive = false;

                stage.removeChild(ship);
                messageField.text = "You're dead:  Click or hit enter to play again";
                stage.addChild(messageField);
                watchRestart();

                //play death sound
                createjs.Sound.play("death", createjs.Sound.INTERRUPT_ANY);
                continue;
            }

            //handle spaceRock bullet collisions
            for(bullet in bulletStream) {
                var p = bulletStream[bullet];
                if(!p || !p.active) { continue; }

                if(o.hitPoint(p.x, p.y)) {
                    var newSize;
                    switch(o.size) {
                        case SpaceRock.LRG_ROCK: newSize = SpaceRock.MED_ROCK;
                            break;
                        case SpaceRock.MED_ROCK: newSize = SpaceRock.SML_ROCK;
                            break;
                        case SpaceRock.SML_ROCK: newSize = 0;
                            break;
                    }

                    //score
                    if(alive) {
                        addScore(o.score);
                    }

                    //create more
                    if(newSize > 0) {
                        var i;
                        var index;
                        var offSet;

                        for(i=0; i < SUB_ROCK_COUNT; i++){
                            index = getSpaceRock(newSize);
                            offSet = (Math.random() * o.size*2) - o.size;
                            rockBelt[index].x = o.x + offSet;
                            rockBelt[index].y = o.y + offSet;
                        }
                    }

                    //remove
                    stage.removeChild(o);
                    rockBelt[spaceRock].active = false;

                    stage.removeChild(p);
                    bulletStream[bullet].active = false;

                    // play sound
                    createjs.Sound.play("break", createjs.Sound.INTERUPT_LATE, 0, 0.8);
                }
            }
        }

        //call sub ticks
        ship.tick(event);
        stage.update(event);
    }

    function outOfBounds(o, bounds) {
        //is it visibly off screen
        return o.x < bounds*-2 || o.y < bounds*-2 || o.x > canvas.width+bounds*2 || o.y > canvas.height+bounds*2;
    }

    function placeInBounds(o, bounds) {
        //if its visual bounds are entirely off screen place it off screen on the other side
        if(o.x > canvas.width+bounds*2) {
            o.x = bounds*-2;
        } else if(o.x < bounds*-2) {
            o.x = canvas.width+bounds*2;
        }

        //if its visual bounds are entirely off screen place it off screen on the other side
        if(o.y > canvas.height+bounds*2) {
            o.y = bounds*-2;
        } else if(o.y < bounds*-2) {
            o.y = canvas.height+bounds*2;
        }
    }

    function fireBullet() {
        //create the bullet
        var o = bulletStream[getBullet()];
        o.x = ship.x;
        o.y = ship.y;
        o.rotation = ship.rotation;
        o.entropy = BULLET_ENTROPY;
        o.active = true;

        //draw the bullet
        o.graphics.beginStroke("#FFFFFF").moveTo(-1, 0).lineTo(1, 0);

        // play the shot sound
        createjs.Sound.play("laser", createjs.Sound.INTERUPT_LATE);
    }

    function getSpaceRock(size) {
        var i = 0;
        var len = rockBelt.length;

        //pooling approach
        while(i <= len){
            if(!rockBelt[i]) {
                rockBelt[i] = new SpaceRock(size);
                break;
            } else if(!rockBelt[i].active) {
                rockBelt[i].activate(size);
                break;
            } else {
                i++;
            }
        }

        if(len == 0) {
            rockBelt[0] = new SpaceRock(size);
        }

        stage.addChild(rockBelt[i]);
        return i;
    }

    function getBullet() {
        var i = 0;
        var len = bulletStream.length;

        //pooling approach
        while(i <= len){
            if(!bulletStream[i]) {
                bulletStream[i] = new createjs.Shape();
                break;
            } else if(!bulletStream[i].active) {
                bulletStream[i].active = true;
                break;
            } else {
                i++;
            }
        }

        if(len == 0) {
            bulletStream[0] = new createjs.Shape();
        }

        stage.addChild(bulletStream[i]);
        return i;
    }

    //allow for WASD and arrow control scheme
    function handleKeyDown(e) {
        //cross browser issues exist
        if(!e){ var e = window.event; }
        switch(e.keyCode) {
            case KEYCODE_SPACE:	shootHeld = true; return false;
            case KEYCODE_A:
            case KEYCODE_LEFT:	lfHeld = true; return false;
            case KEYCODE_D:
            case KEYCODE_RIGHT: rtHeld = true; return false;
            case KEYCODE_W:
            case KEYCODE_UP:	fwdHeld = true; return false;
            case KEYCODE_ENTER:	 if(canvas.onclick == handleClick){ handleClick(); }return false;
        }
    }

    function handleKeyUp(e) {
        //cross browser issues exist
        if(!e){ var e = window.event; }
        switch(e.keyCode) {
            case KEYCODE_SPACE:	shootHeld = false; break;
            case KEYCODE_A:
            case KEYCODE_LEFT:	lfHeld = false; break;
            case KEYCODE_D:
            case KEYCODE_RIGHT: rtHeld = false; break;
            case KEYCODE_W:
            case KEYCODE_UP:	fwdHeld = false; break;
        }
    }

    function addScore(value) {
        //trust the field will have a number and add the score
        scoreField.text = (Number(scoreField.text) + Number(value)).toString();
    }

    </script>

  </head>

  <style type="text/css">
      #content{margin: 0 auto;user-select: none;background-color:#000000;width: 960px;height: 400px;}
      .title{margin: 0 auto;text-align: center;font-size: 45px;}
      #gameCanvas{background-image: url(assets/background.jpg);}
  </style>

  <body onload="init();">
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/novitskiy-aleksei/html5-game">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/novitskiy-aleksei/html5-game/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/novitskiy-aleksei/html5-game/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Html5-game</h1>
          <p></p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/novitskiy-aleksei">novitskiy-aleksei</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

          <div id="content">
              <canvas id="gameCanvas" width="960" height="400"></canvas>
          </div>

          <div id="error">
              <h1>Sorry!</h1>
              <p>SoundJS is not currently supported in your browser.</p>
          </div>

        <h3>
<a name="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages"><span class="octicon octicon-link"></span></a>Welcome to GitHub Pages.</h3>

<p>This automatic page generator is the easiest way to create beautiful pages for all of your projects. Author your page content here using GitHub Flavored Markdown, select a template crafted by a designer, and publish. After your page is generated, you can check out the new branch:</p>

<pre><code>$ cd your_repo_root/repo_name
$ git fetch origin
$ git checkout gh-pages
</code></pre>

<p>If you're using the GitHub for Mac, simply sync your repository and you'll see the new branch.</p>

<h3>
<a name="designer-templates" class="anchor" href="#designer-templates"><span class="octicon octicon-link"></span></a>Designer Templates</h3>

<p>We've crafted some handsome templates for you to use. Go ahead and continue to layouts to browse through them. You can easily go back to edit your page before publishing. After publishing your page, you can revisit the page generator and switch to another theme. Your Page content will be preserved if it remained markdown format.</p>

<h3>
<a name="rather-drive-stick" class="anchor" href="#rather-drive-stick"><span class="octicon octicon-link"></span></a>Rather Drive Stick?</h3>

<p>If you prefer to not use the automatic generator, push a branch named <code>gh-pages</code> to your repository to create a page manually. In addition to supporting regular HTML content, GitHub Pages support Jekyll, a simple, blog aware static site generator written by our own Tom Preston-Werner. Jekyll makes it easy to create site-wide headers and footers without having to copy them across every page. It also offers intelligent blog support and other advanced templating features.</p>

<h3>
<a name="authors-and-contributors" class="anchor" href="#authors-and-contributors"><span class="octicon octicon-link"></span></a>Authors and Contributors</h3>

<p>You can <a href="https://github.com/blog/821" class="user-mention">@mention</a> a GitHub username to generate a link to their profile. The resulting <code>&lt;a&gt;</code> element will link to the contributor's GitHub Profile. For example: In 2007, Chris Wanstrath (<a href="https://github.com/defunkt" class="user-mention">@defunkt</a>), PJ Hyett (<a href="https://github.com/pjhyett" class="user-mention">@pjhyett</a>), and Tom Preston-Werner (<a href="https://github.com/mojombo" class="user-mention">@mojombo</a>) founded GitHub.</p>

<h3>
<a name="support-or-contact" class="anchor" href="#support-or-contact"><span class="octicon octicon-link"></span></a>Support or Contact</h3>

<p>Having trouble with Pages? Check out the documentation at <a href="http://help.github.com/pages">http://help.github.com/pages</a> or contact <a href="mailto:support@github.com">support@github.com</a> and we’ll help you sort it out.</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>